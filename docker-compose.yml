version: "3.8"

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: log-viewer
    ports:
      - "3000:3000"
    volumes:
      # 挂载代码目录（支持内部升级）
      - .:/app
      # 挂载文件目录（只读）- 服务模式只能访问此目录
      - ./files:/app/files:ro
      # 挂载日志目录（应用日志输出）
      - ./logs:/app/logs
      # 排除 node_modules（使用容器内的）
      - /app/node_modules
    environment:
      # 认证配置
      - ACCESS_PASSWORD=${ACCESS_PASSWORD:-default_password}
      - SESSION_SECRET=${SESSION_SECRET:-change-me-in-production}
      - PASSWORD_HASH=${PASSWORD_HASH:-}
      - AUTH_ENABLED=${AUTH_ENABLED:-true}
      # 文件系统配置
      - FILES_DIRECTORY=/app/files
      - ENABLE_LOCAL_FS=true
      - NODE_ENV=production
      # 日志配置
      - LOG_DIR=/app/logs
      - LOG_LEVEL=${LOG_LEVEL:-info}
    # 自动重启策略
    restart: unless-stopped
    # 健康检查（可选）
    # healthcheck:
    #   test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/auth/status"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 40s
    # 资源限制（可选）
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 1G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 512M
    # 如果需要，可以指定命令
    # command: pnpm start
